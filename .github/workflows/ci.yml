name: CI Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality (Pint & PHPStan)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare modules workspace
        run: mkdir -p "$GITHUB_WORKSPACE/ercee-modules"

      - name: Checkout module-forms
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-forms
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-forms

      - name: Checkout module-commerce
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-commerce
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-commerce

      - name: Checkout module-funnel
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-funnel
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-funnel

      - name: Checkout module-llm
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-llm
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-llm

      - name: Checkout module-theme-builds
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-theme-builds
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-theme-builds

      - name: Prepare path repository for Composer
        run: ln -sfn "$GITHUB_WORKSPACE/ercee-modules" "$GITHUB_WORKSPACE/../ercee-modules"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-8.3-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-8.3-composer-

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress --ansi

      - name: Resolve changed PHP files for quality checks
        id: changed-php
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.base_ref }}"
            git fetch --no-tags --depth=1 origin "${BASE_REF}:${BASE_REF}"
            RANGE="${BASE_REF}...HEAD"
          else
            BEFORE="${{ github.event.before }}"
            if [ -n "${BEFORE}" ] && [ "${BEFORE}" != "0000000000000000000000000000000000000000" ]; then
              RANGE="${BEFORE}...HEAD"
            else
              RANGE="HEAD"
            fi
          fi

          if [ "${RANGE}" = "HEAD" ]; then
            git show --name-only --pretty=format: HEAD | grep -E '\.php$' > .changed-php-files || true
          else
            git diff --name-only "${RANGE}" | grep -E '\.php$' > .changed-php-files || true
          fi

          COUNT="$(wc -l < .changed-php-files | tr -d ' ')"
          echo "count=${COUNT}" >> "$GITHUB_OUTPUT"
          echo "Detected ${COUNT} changed PHP files."

      - name: Check code style with Pint (changed files only)
        if: steps.changed-php.outputs.count != '0'
        run: xargs ./vendor/bin/pint --test --ansi < .changed-php-files

      - name: Skip Pint (no changed PHP files)
        if: steps.changed-php.outputs.count == '0'
        run: echo "No changed PHP files. Skipping Pint."

      - name: Run PHPStan static analysis (changed files only)
        if: steps.changed-php.outputs.count != '0'
        run: xargs ./vendor/bin/phpstan analyse --memory-limit=2G --ansi < .changed-php-files

      - name: Skip PHPStan (no changed PHP files)
        if: steps.changed-php.outputs.count == '0'
        run: echo "No changed PHP files. Skipping PHPStan."

  tests-php83:
    name: PHP 8.3 - Laravel 12.*
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare modules workspace
        run: mkdir -p "$GITHUB_WORKSPACE/ercee-modules"

      - name: Checkout module-forms
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-forms
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-forms

      - name: Checkout module-commerce
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-commerce
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-commerce

      - name: Checkout module-funnel
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-funnel
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-funnel

      - name: Checkout module-llm
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-llm
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-llm

      - name: Checkout module-theme-builds
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-theme-builds
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-theme-builds

      - name: Prepare path repository for Composer
        run: ln -sfn "$GITHUB_WORKSPACE/ercee-modules" "$GITHUB_WORKSPACE/../ercee-modules"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-8.3-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-8.3-composer-

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress --ansi

      - name: Prepare Laravel Application
        run: |
          cp .env.example .env
          php artisan key:generate --ansi
          touch database/database.sqlite
          php artisan migrate --force --path=database/migrations --ansi

      - name: Run Root Test Suites (Unit + Feature)
        run: php artisan test --ansi --testsuite=Unit,Feature

  tests-php84:
    name: PHP 8.4 - Laravel 12.*
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare modules workspace
        run: mkdir -p "$GITHUB_WORKSPACE/ercee-modules"

      - name: Checkout module-forms
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-forms
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-forms

      - name: Checkout module-commerce
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-commerce
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-commerce

      - name: Checkout module-funnel
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-funnel
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-funnel

      - name: Checkout module-llm
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-llm
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-llm

      - name: Checkout module-theme-builds
        uses: actions/checkout@v4
        with:
          repository: zlizlobr/ercee-module-theme-builds
          token: ${{ secrets.MODULES_REPO_TOKEN || github.token }}
          path: ercee-modules/ercee-module-theme-builds

      - name: Prepare path repository for Composer
        run: ln -sfn "$GITHUB_WORKSPACE/ercee-modules" "$GITHUB_WORKSPACE/../ercee-modules"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-8.4-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-8.4-composer-

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress --ansi

      - name: Prepare Laravel Application
        run: |
          cp .env.example .env
          {
            echo "FRONTEND_REBUILD_ENABLED=false"
            echo "FRONTEND_REBUILD_MODE=log"
            echo "GITHUB_TOKEN=test-token"
            echo "GITHUB_FRONTEND_REPOSITORY=test-org/test-frontend"
            echo "MODULE_LOAD_MIGRATIONS=true"
            echo "MODULE_MIGRATION_ALLOWLIST=forms"
          } >> .env
          php artisan config:clear --ansi
          php artisan key:generate --ansi
          touch database/database.sqlite
          php artisan migrate --force --path=database/migrations --ansi

      - name: Run Root Test Suites (Unit + Feature)
        run: php artisan test --ansi --testsuite=Unit,Feature
